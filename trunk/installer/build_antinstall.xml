<!--
  Copyright (C) 2007 Unicon, Inc.

  This program is free software; you can redistribute it and/or
  modify it under the terms of the GNU General Public License
  as published by the Free Software Foundation; either version 2
  of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this distribution.  It is also available here:
  http://www.fsf.org/licensing/licenses/gpl.html

  As a special exception to the terms and conditions of version 
  2 of the GPL, you may redistribute this Program in connection 
  with Free/Libre and Open Source Software ("FLOSS") applications 
  as described in the GPL FLOSS exception.  You should have received
  a copy of the text describing the FLOSS exception along with this
  distribution.
-->
<project name="toro-deployment" default="driver" basedir="${basedir}"
    xmlns:artifact="urn:maven-artifact-ant">

    <property file="build.properties"/>
    <property file="ant.install.properties"/>
    <property name="tomcat.home" value="[SET IN BUILD.PROPERTIES!]" />
    <property name="portal.webapp.home" value="[SET IN BUILD.PROPERTIES!]" />
    <property name="work.dir" value="${basedir}/work"/>
    <property name="minJavaVersion" value="1.5"/>

    <property name="webapp.home" value="${tomcat.home}/webapps" />
    <property name="db.driver.version" value=""/>

    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant">
        <classpath>
            <pathelement path="${basedir}"/>
        </classpath>
    </typedef>

    <artifact:dependencies pathId="ant-contrib.pathId">
        <dependency groupId="ant-contrib" artifactId="ant-contrib"
            version="${ant-contrib.version}" type="jar"/>
        <remoteRepository refid="toro.repository" />
    </artifact:dependencies>
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath refId="ant-contrib.pathId"/>
    </taskdef>

    <!--taskdef name="filtered-dependencies" classname="net.unicon.toro.installer.anttask.FilteredDependenciesTask" classpath="${basedir}"/-->

    <artifact:pom id="maven.project" file="${basedir}/pom.xml" />

    <artifact:remoteRepository
        id="uportal.repository"
        url="${uportal.remote.repo}" />

    <artifact:remoteRepository
        id="toro.repository"
        url="${toro.remote.repo}" />

    <artifact:remoteRepository
        id="central.repository"
        url="${central.remote.repo}" />

    <artifact:dependencies pathId="db.classpath">
        <dependency groupId="net.sourceforge.jtds" artifactId="jtds"
            version="${jtds.version}" type="jar"/>
        <dependency groupId="mysql" artifactId="mysql-connector-java"
            version="${mysql.version}" type="jar"/>
        <dependency groupId="com.oracle" artifactId="ojdbc14"
            version="${oracle.version}" type="jar"/>
        <dependency groupId="postgresql" artifactId="postgresql"
            version="${postgresql.version}" type="jar"/>
        <remoteRepository refid="toro.repository" />
    </artifact:dependencies>

    <!--  Driver targets  -->
    <target name="clean" depends="clean-portlets">
        <delete dir="${work.dir}"/>
        <delete dir="${webapp.home}/toro-portlets-common"/>
        <delete>
            <fileset dir="${tomcat.home}/shared/lib">
                <include name="academus-api*.jar"/>
                <include name="sso-authentication-cache*.jar"/>
            </fileset>
        </delete>
        <available property="uportal.deployment.exists" file="${portal.webapp.home}/WEB-INF/lib"/>
        <antcall target="clean-uportal-academus-api"/>
    </target>

    <target name="clean-uportal-academus-api" if="uportal.deployment.exists">
        <delete>
            <fileset dir="${portal.webapp.home}/WEB-INF/lib">
                <include name="uportal-academus-api*.jar"/>
            </fileset>
        </delete>
    </target>

    <target name="initialize-run-targets">

        <if>
            <equals arg1="${remote.configuration}" arg2="true"/>
            <then>
                <fail>Remote Configuration .. aborting.</fail>
            </then>
        </if>

        <condition property="run.uportal.deploy">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.channel.common">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${cms.active}" arg2="true"/>
                <equals arg1="${survey.active}" arg2="true"/>
                <equals arg1="${news.active}" arg2="true"/>
                <equals arg1="${classifieds.active}" arg2="true"/>
                <equals arg1="${calendar.active}" arg2="true"/>
                <equals arg1="${notes.active}" arg2="true"/>
                <equals arg1="${bookmarks.active}" arg2="true"/>
                <equals arg1="${campusannouncement.active}" arg2="true"/>
                <equals arg1="${addressbook.active}" arg2="true"/>
                <equals arg1="${ldapchangepw.active}" arg2="true"/>
                <equals arg1="${useradmin.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.portlets.common">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${run.deploy.channel.common}" arg2="true"/>
                <equals arg1="${briefcase-portlet.active}" arg2="true"/>
                <equals arg1="${messaging-portlet.active}" arg2="true"/>
                <equals arg1="${permissions-portlet.active}" arg2="true"/>
                <equals arg1="${gateway-portlet.active}" arg2="true"/>
                <equals arg1="${web-content-portlet.active}" arg2="true"/>
                <equals arg1="${blojsom.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.toro.common">
            <or>
                <equals arg1="${run.deploy.channel.common}" arg2="true"/>
                <equals arg1="${run.deploy.portlets.common}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.briefcase.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${briefcase-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.messaging.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${messaging-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.permissions.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${permissions-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.gateway.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${gateway-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.web.content.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${web-content-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.blojsom.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${blojsom.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.survey.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${survey.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.cms.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${cms.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.news.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${news.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.classifieds.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${classifieds.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.calendar.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${calendar.active}" arg2="true"/>
                <equals arg1="${cms.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.notes.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${notes.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.bookmarks.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${bookmarks.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.campusannouncement.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${campusannouncement.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.ldapchangepw.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${ldapchangepw.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.useradmin.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${useradmin.active}" arg2="true"/>
                <equals arg1="${cms.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.deploy.login.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${login.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.ldap.merge">
            <or>
                <equals arg1="${ldap.checkbox}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.briefcase.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${briefcase-portlet.publish}" arg2="true"/>
                <equals arg1="${briefcase-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.gateway.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${gateway-portlet.publish}" arg2="true"/>
                <equals arg1="${gateway-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.messaging.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${messaging-portlet.publish}" arg2="true"/>
                <equals arg1="${messaging-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.permissions.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${permissions-portlet.publish}" arg2="true"/>
                <equals arg1="${permissions-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.web.content.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${web-content-portlet.publish}" arg2="true"/>
                <equals arg1="${web-content-portlet.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.survey.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${survey.publish}" arg2="true"/>
                <equals arg1="${survey.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.cms.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${cms.publish}" arg2="true"/>
                <equals arg1="${cms.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.news.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${news.publish}" arg2="true"/>
                <equals arg1="${news.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.classifieds.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${classifieds.publish}" arg2="true"/>
                <equals arg1="${classifieds.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.calendar.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${calendar.publish}" arg2="true"/>
                <equals arg1="${run.deploy.calendar.channel}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.notes.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${notes.publish}" arg2="true"/>
                <equals arg1="${notes.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.bookmarks.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${bookmarks.publish}" arg2="true"/>
                <equals arg1="${bookmarks.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.campusannouncement.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${campusannouncement.publish}" arg2="true"/>
                <equals arg1="${campusannouncement.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.ldapchangepw.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${ldapchangepw.publish}" arg2="true"/>
                <equals arg1="${ldapchangepw.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.useradmin.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${useradmin.publish}" arg2="true"/>
                <equals arg1="${run.deploy.useradmin.channel}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.login.channel">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${login.publish}" arg2="true"/>
                <equals arg1="${login.active}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.publish.common.channels">
            <or>
                <equals arg1="${run.publish.cms.channel}" arg2="true"/>
                <equals arg1="${run.publish.survey.channel}" arg2="true"/>
                <equals arg1="${run.publish.news.channel}" arg2="true"/>
                <equals arg1="${run.publish.classifieds.channel}" arg2="true"/>
                <equals arg1="${run.publish.calendar.channel}" arg2="true"/>
                <equals arg1="${run.publish.notes.channel}" arg2="true"/>
                <equals arg1="${run.publish.bookmarks.channel}" arg2="true"/>
                <equals arg1="${run.publish.campusannouncement.channel}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.db">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${uportal.db}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.pubchan">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${uportal.pubchan}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.i18n.db">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${uportal.i18n.db}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.pubfragments">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${uportal.pubfragments}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.deploy.testsuite.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy.testsuite.portlet}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.deploy.proxyportlet.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy.proxyportlet.portlet}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.deploy.bookmarks.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy.bookmarks.portlet}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.deploy.rss.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy.rss.portlet}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.uportal.deploy.google.portlet">
            <or>
                <equals arg1="${deploy.all}" arg2="true"/>
                <equals arg1="${uportal.deploy.google.portlet}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.hibernate.alchemist">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${hibernate.alchemist}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.hibernate.demetrius">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${hibernate.demetrius}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.hibernate.mercury">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${hibernate.mercury}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.hibernate.portlets-common">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${hibernate.portlets-common}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.cdk">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.cdk}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.toro.common">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.toro.common}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.survey">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.survey}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.cms">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.cms}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.news">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.news}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.classifieds">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.classifieds}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.calendar">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.calendar}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.notes">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.notes}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.bookmarks">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.bookmarks}" arg2="true"/>
            </or>
        </condition>
        <condition property="run.dbloader.campusannouncement">
            <or>
                <equals arg1="${initialize.all}" arg2="true"/>
                <equals arg1="${dbloader.campusannouncement}" arg2="true"/>
            </or>
        </condition>
        <condition property="hibernate.create.only" value="--create">
            <equals arg1="${hibernate.create.only.checkbox}" arg2="true"/>
        </condition>
        <condition property="uportal.db.droptables.arg" value="-nD">
            <equals arg1="${hibernate.create.only.checkbox}" arg2="true"/>
        </condition>
        <condition property="hibernate.create.only" value=" ">
            <not><equals arg1="${hibernate.create.only.checkbox}" arg2="true"/></not>
        </condition>
        <condition property="uportal.db.droptables.arg" value=" ">
            <not><equals arg1="${hibernate.create.only.checkbox}" arg2="true"/></not>
        </condition>

        <condition property="postgres.platform" value="true">
            <contains string="${jdbc.driver}" substring="postgres"/>
        </condition>
        <condition property="oracle.platform" value="true">
            <contains string="${jdbc.driver}" substring="oracle"/>
        </condition>
        <condition property="sqlserver.platform" value="true">
            <or>
                <contains string="${jdbc.driver}" substring="jtds"/>
                <contains string="${jdbc.driver}" substring="jnetdirect"/>
            </or>
        </condition>
        <condition property="mysql.platform" value="true">
            <contains string="${jdbc.driver}" substring="mysql"/>
        </condition>
    </target>

    <target name="set-resource-tokens">
        <if>
            <equals arg1="${multibox.configuration}" arg2="true"/>
            <then>
                <property name="multibox.comment" value=""/>
                <property name="dirty.cache.request.handler" value="net.unicon.portal.cache.jms.JMSDirtyCacheRequestHandlerImpl"/>
            </then>
            <else>
                <property name="multibox.comment" value="!--"/>
                <property name="dirty.cache.request.handler" value="net.unicon.portal.cache.SBDirtyCacheRequestHandlerImpl"/>
            </else>
        </if>
        <if>
            <equals arg1="${ldap.checkbox}" arg2="true"/>
            <then>
                <property name="ldap.comment" value=""/>
                <if>
                    <equals arg1="${ldap.protocol.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap.protocol" value="ssl"/>
                        <property name="ldap.protocol.prefix" value="ldaps"/>
                    </then>
                    <else>
                        <property name="ldap.protocol" value=""/>
                        <property name="ldap.protocol.prefix" value="ldap"/>
                    </else>
                </if>
            </then>
            <else>
                <property name="ldap.comment" value="!--"/>
            </else>
        </if>
        <if>
            <and>
                <equals arg1="${ldap2.checkbox}" arg2="true"/>
            </and>
            <then>
                <property name="ldap2.comment" value=""/>
                <if>
                    <equals arg1="${ldap2.protocol.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap2.protocol" value="ssl"/>
                        <property name="ldap2.protocol.prefix" value="ldaps"/>
                    </then>
                    <else>
                        <property name="ldap2.protocol" value=""/>
                        <property name="ldap2.protocol.prefix" value="ldap"/>
                    </else>
                </if>
            </then>
            <else>
                <if>
                    <equals arg1="${ldap.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap2.comment" value="!--"/>
                    </then>
                    <else>
                        <property name="ldap2.comment" value=""/>
                    </else>
                </if>
            </else>
        </if>
        <if>
            <and>
                <equals arg1="${ldap3.checkbox}" arg2="true"/>
            </and>
            <then>
                <property name="ldap3.comment" value=""/>
                <if>
                    <equals arg1="${ldap3.protocol.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap3.protocol" value="ssl"/>
                        <property name="ldap3.protocol.prefix" value="ldaps"/>
                    </then>
                    <else>
                        <property name="ldap3.protocol" value=""/>
                        <property name="ldap3.protocol.prefix" value="ldap"/>
                    </else>
                </if>
            </then>
            <else>
                <if>
                    <equals arg1="${ldap.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap3.comment" value="!--"/>
                    </then>
                    <else>
                        <property name="ldap3.comment" value=""/>
                    </else>
                </if>
            </else>
        </if>
        <if>
            <and>
                <equals arg1="${ldap4.checkbox}" arg2="true"/>
            </and>
            <then>
                <property name="ldap4.comment" value=""/>
                <if>
                    <equals arg1="${ldap4.protocol.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap4.protocol" value="ssl"/>
                        <property name="ldap4.protocol.prefix" value="ldaps"/>
                    </then>
                    <else>
                        <property name="ldap4.protocol" value=""/>
                        <property name="ldap4.protocol.prefix" value="ldap"/>
                    </else>
                </if>
            </then>
            <else>
                <if>
                    <equals arg1="${ldap.checkbox}" arg2="true"/>
                    <then>
                        <property name="ldap4.comment" value="!--"/>
                    </then>
                    <else>
                        <property name="ldap4.comment" value=""/>
                    </else>
                </if>
            </else>
        </if>
        <filterset id="tokens">
            <filtersfile file="${basedir}/build.properties"/>
            <filtersfile file="${basedir}/ant.install.properties"/>
            <filter token="db.platform" value="${db.platform}"/>
            <filter token="jdbc.simplesql" value="${jdbc.simplesql}"/>
            <filter token="db.time.impl" value="${db.time.impl}"/>
            <filter token="db.sqlconcat" value="${db.sqlconcat}"/>
            <filter token="db.length" value="${db.length}"/>
            <filter token="cms.enabled" value="${run.deploy.cms.channel}"/>
            <filter token="multibox.configuration" value="${multibox.configuration}"/>
            <filter token="multibox.comment" value="${multibox.comment}"/>
            <filter token="dirty.cache.request.handler" value="${dirty.cache.request.handler}"/>
            <filter token="ldap.comment" value="${ldap.comment}"/>
            <filter token="ldap.protocol" value="${ldap.protocol}"/>
            <filter token="ldap.protocol.prefix" value="${ldap.protocol.prefix}"/>
            <filter token="ldap2.comment" value="${ldap2.comment}"/>
            <filter token="ldap2.protocol" value="${ldap2.protocol}"/>
            <filter token="ldap2.protocol.prefix" value="${ldap2.protocol.prefix}"/>
            <filter token="ldap3.comment" value="${ldap3.comment}"/>
            <filter token="ldap3.protocol" value="${ldap3.protocol}"/>
            <filter token="ldap3.protocol.prefix" value="${ldap3.protocol.prefix}"/>
            <filter token="ldap4.comment" value="${ldap4.comment}"/>
            <filter token="ldap4.protocol" value="${ldap4.protocol}"/>
            <filter token="ldap4.protocol.prefix" value="${ldap4.protocol.prefix}"/>
        </filterset>
    </target>

    <target name="set-postgres-platform-specific-properties">
        <if>
            <isset property="postgres.platform"/>
            <then>
                <echo>Setting postgres specific properties...</echo>
                <property name="db.platform" value="postgres"/>
                <property name="jdbc.simplesql" value="select 1"/>
                <property name="db.time.impl" value="net.unicon.portal.util.PostgresTimeServiceImpl"/>
                <property name="db.sqlconcat" value="||"/>
                <property name="db.length" value="length"/>
                <property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
            </then>
        </if>
    </target>

    <target name="set-oracle-platform-specific-properties">
        <if>
            <isset property="postgres.platform"/>
            <then>
                <echo>Setting oracle specific properties...</echo>
                <property name="db.platform" value="oracle"/>
                <property name="jdbc.simplesql" value="select 1 from dual"/>
                <property name="db.time.impl" value="net.unicon.portal.util.OracleTimeServiceImpl"/>
                <property name="db.sqlconcat" value="||"/>
                <property name="db.length" value="length"/>
                <property name="hibernate.dialect" value="org.hibernate.dialect.OracleDialect"/>
            </then>
        </if>
    </target>

    <target name="set-sqlserver-platform-specific-properties">
        <if>
            <isset property="postgres.platform"/>
            <then>
                <echo>Setting sqlserver specific properties...</echo>
                <property name="db.platform" value="sqlserver"/>
                <property name="jdbc.simplesql" value="select 1"/>
                <property name="db.time.impl" value="net.unicon.portal.util.SqlServerTimeServiceImpl"/>
                <property name="db.sqlconcat" value="+"/>
                <property name="db.length" value="datalength"/>
                <property name="hibernate.dialect" value="org.hibernate.dialect.SQLServerDialect"/>
            </then>
        </if>
    </target>

    <target name="set-mysql-platform-specific-properties">
        <if>
            <isset property="postgres.platform"/>
            <then>
                <echo>Setting mysql specific properties...</echo>
                <property name="db.platform" value="mysql"/>
                <property name="jdbc.simplesql" value="select 1"/>
                <property name="db.time.impl" value="net.unicon.portal.util.MySqlTimeServiceImpl"/>
                <property name="db.sqlconcat" value="||"/>
                <property name="db.length" value="length"/>
                <property name="hibernate.dialect" value="org.hibernate.dialect.MySQL5Dialect"/>
            </then>
        </if>
    </target>

    <target name="dump-properties">
        <echo>
Executing with properties:

Runtime properties:
run.uportal.deploy=${run.uportal.deploy}
run.deploy.briefcase.portlet=${run.deploy.briefcase.portlet}
run.deploy.messaging.portlet=${run.deploy.messaging.portlet}
run.deploy.permissions.portlet=${run.deploy.permissions.portlet}
run.deploy.gateway.portlet=${run.deploy.gateway.portlet}
run.deploy.web.content.portlet=${run.deploy.web.content.portlet}
run.deploy.blojsom.portlet=${run.deploy.blojsom.portlet}
run.deploy.cms.channel=${run.deploy.cms.channel}
run.deploy.survey.channel=${run.deploy.survey.channel}
run.deploy.news.channel=${run.deploy.news.channel}
run.deploy.classifieds.channel=${run.deploy.classifieds.channel}
run.deploy.calendar.channel=${run.deploy.calendar.channel}
run.deploy.notes.channel=${run.deploy.notes.channel}
run.deploy.bookmarks.channel=${run.deploy.bookmarks.channel}
run.deploy.campusannouncement.channel=${run.deploy.campusannouncement.channel}
run.deploy.ldapchangepw.channel=${run.deploy.ldapchangepw.channel}
run.deploy.login.channel=${run.deploy.login.channel}
run.deploy.useradmin.channel=${run.deploy.useradmin.channel}
run.ldap.merge=${run.ldap.merge}
run.publish.briefcase.portlet=${run.publish.briefcase.portlet}
run.publish.gateway.portlet=${run.publish.gateway.portlet}
run.publish.messaging.portlet=${run.publish.messaging.portlet}
run.publish.permissions.portlet=${run.publish.permissions.portlet}
run.publish.web.content.portlet=${run.publish.web.content.portlet}
run.publish.cms.channel=${run.publish.cms.channel}
run.publish.survey.channel=${run.publish.survey.channel}
run.publish.news.channel=${run.publish.news.channel}
run.publish.classifieds.channel=${run.publish.classifieds.channel}
run.publish.calendar.channel=${run.publish.calendar.channel}
run.publish.notes.channel=${run.publish.notes.channel}
run.publish.bookmarks.channel=${run.publish.bookmarks.channel}
run.publish.campusannouncement.channel=${run.publish.campusannouncement.channel}
run.publish.ldapchangepw.channel=${run.publish.ldapchangepw.channel}
run.publish.login.channel=${run.publish.login.channel}
run.publish.useradmin.channel=${run.publish.useradmin.channel}
run.uportal.db=${run.uportal.db}
run.uportal.pubchan=${run.uportal.pubchan}
run.uportal.i18n.db=${run.uportal.i18n.db}
run.uportal.pubfragments=${run.uportal.pubfragments}
run.uportal.deploy.testsuite.portlet=${run.uportal.deploy.testsuite.portlet}
run.uportal.deploy.proxyportlet.portlet=${run.uportal.deploy.proxyportlet.portlet}
run.uportal.deploy.bookmarks.portlet=${run.uportal.deploy.bookmarks.portlet}
run.uportal.deploy.rss.portlet=${run.uportal.deploy.rss.portlet}
run.uportal.deploy.google.portlet=${run.uportal.deploy.google.portlet}
run.hibernate.alchemist=${run.hibernate.alchemist}
run.hibernate.demetrius=${run.hibernate.demetrius}
run.hibernate.mercury=${run.hibernate.mercury}
run.hibernate.portlets-common=${run.hibernate.portlets-common}
run.dbloader.cdk=${run.dbloader.cdk}
run.dbloader.toro.common=${run.dbloader.toro.common}
run.dbloader.cms=${run.dbloader.cms}
run.dbloader.survey=${run.dbloader.survey}
run.dbloader.news=${run.dbloader.news}
run.dbloader.classifieds=${run.dbloader.classifieds}
run.dbloader.calendar=${run.dbloader.calendar}
run.dbloader.notes=${run.dbloader.notes}
run.dbloader.bookmarks=${run.dbloader.bookmarks}
run.dbloader.campusannouncement=${run.dbloader.campusannouncement}
hibernate.create.only=${hibernate.create.only}
uportal.db.droptables.arg=${uportal.db.droptables.arg}
db.platform=${db.platform}
jdbc.simplesql=${jdbc.simplesql}
db.time.impl=${db.time.impl}
db.sqlconcat=${db.sqlconcat}
db.length=${db.length}
multibox.configuration=${multibox.configuration}
multibox.comment=${multibox.comment}
dirty.cache.request.handler=${dirty.cache.request.handler}
ldap.protocol=${ldap.protocol}
ldap.comment=${ldap.comment}
ldap.protocol=${ldap.protocol}
ldap2.comment=${ldap2.comment}
ldap2.protocol=${ldap2.protocol}
ldap3.comment=${ldap3.comment}
ldap3.protocol=${ldap3.protocol}
ldap4.comment=${ldap4.comment}
ldap4.protocol=${ldap4.protocol}

Given Properties:
uportal.remote.repo=${uportal.remote.repo}
toro.remote.repo=${toro.remote.repo}
spell.executable.path=${aspell.executable.path}
backport-util-concurrent.version=${backport-util-concurrent.version}
blojsom.active=${blojsom.active}
briefcase-portlet.active=${briefcase-portlet.active}
briefcase-portlet.publish=${briefcase-portlet.publish}
common.libraries=${common.libraries}
common.portlets.webapp=${common.portlets.webapp}
commons-dbcp.version=${commons-dbcp.version}
commons-logging.version=${commons-logging.version}
datasource=${datasource}
db.platform=${db.platform}
deploy.all=${deploy.all}
dom4j.version=${dom4j.version}
gateway-portlet.active=${gateway-portlet.active}
gateway-portlet.publish=${gateway-portlet.publish}
hibernate.alchemist=${hibernate.alchemist}
hibernate.cdk=${hibernate.cdk}
hibernate.create.only=${hibernate.create.only}
hibernate.create.only.checkbox=${hibernate.create.only.checkbox}
hibernate.demetrius=${hibernate.demetrius}
hibernate.mercury=${hibernate.mercury}
hibernate.portlets-common=${hibernate.portlets-common}
hibernate.version=${hibernate.version}
initialize.all=${initialize.all}
jaxen.version=${jaxen.version}
jdbc.driver=${jdbc.driver}
jdbc.password=${jdbc.password}
jdbc.password.confirm=${jdbc.password.confirm}
jdbc.poolsize.blojsom=${jdbc.poolsize.blojsom}
jdbc.poolsize.briefcase=${jdbc.poolsize.briefcase}
jdbc.poolsize.gateway=${jdbc.poolsize.gateway}
jdbc.poolsize.messaging=${jdbc.poolsize.messaging}
jdbc.poolsize.permissions=${jdbc.poolsize.permissions}
jdbc.poolsize.uportal=${jdbc.poolsize.uportal}
jdbc.poolsize.web.content=${jdbc.poolsize.web.content}
jdbc.simplesql=${jdbc.simplesql}
jdbc.url=${jdbc.url}
jdbc.user=${jdbc.user}
jetspeed.version=${jetspeed.version}
jstl.version=${jstl.version}
jtds.version=${jtds.version}
messaging-portlet.active=${messaging-portlet.active}
messaging-portlet.publish=${messaging-portlet.publish}
mysql.version=${mysql.version}
oracle.version=${oracle.version}
permissions-portlet.active=${permissions-portlet.active}
permissions-portlet.publish=${permissions-portlet.publish}
pluto.version=${pluto.version}
portal.base.url=${portal.base.url}
portal.server.hostname=${portal.server.hostname}
portal.server.http.protocol=${portal.server.http.protocol}
portal.server.port=${portal.server.port}
portal.webapp.home=${portal.webapp.home}
portal.webapp.name=${portal.webapp.name}
portlet-api.version=${portlet-api.version}
postgresql.version=${postgresql.version}
project.version=${project.version}
reddot.content.path=${reddot.content.path}
reddot.method=${reddot.method}
reddot.url=${reddot.url}
serializer.version=${serializer.version}
server.base.url=${server.base.url}
servlet-api.version=${servlet-api.version}
smtp.server.hostname=${smtp.server.hostname}
smtp.server.password=${smtp.server.password}
smtp.server.password.confirm=${smtp.server.password.confirm}
smtp.server.port=${smtp.server.port}
smtp.server.username=${smtp.server.username}
springframework.version=${springframework.version}
standard.version=${standard.version}
tomcat.home=${tomcat.home}
tomcat.host.conf=${tomcat.host.conf}
toro.data.home=${toro.data.home}
uportal.db=${uportal.db}
uportal.db.droptables.arg=${uportal.db.droptables.arg}
uportal.deploy=${uportal.deploy}
uportal.deploy.testsuite.portlet=${uportal.deploy.testsuite.portlet}
uportal.deploy.proxyportlet.portlet=${uportal.deploy.proxyportlet.portlet}
uportal.deploy.bookmarks.portlet=${uportal.deploy.bookmarks.portlet}
uportal.deploy.rss.portlet=${uportal.deploy.rss.portlet}
uportal.deploy.google.portlet=${uportal.deploy.google.portlet}
uportal.i18n.db=${uportal.i18n.db}
uportal.pubchan=${uportal.pubchan}
uportal.pubfragments=${uportal.pubfragments}
uportal.version=${uportal.version}
web-content-portlet.active=${web-content-portlet.active}
web-content-portlet.publish=${web-content-portlet.publish}
xalan.version=${xalan.version}
xercesImpl.version=${xercesImpl.version}
        </echo>
    </target>

    <target name="check-java-version">
        <echo message="basedir: ${basedir}"/>
        <taskdef name="javaversion" classname="net.unicon.toro.installer.anttask.JavaVersionTask" classpath="${basedir}"/>
        <javaversion minVersion="${minJavaVersion}" property="javaversion.ok"/>
        <fail unless="javaversion.ok"
            message="ERROR: Java version too old: found ${java.version}, needs ${minJavaVersion}."/> 
    </target>

    <target name="remote-config">
        <!-- if it's being executed from the remote configured machine, then execute away.. -->
        <taskdef name="sethostname" classname="net.unicon.toro.installer.anttask.SetHostname" classpath="${basedir}"/>
        <sethostname property="my.hostname"/>
        <echo>Checking hostnames. (configured remote=${portal.server.hostname}, this host=${my.hostname})</echo>
        <if>
            <equals arg1="${portal.server.hostname}" arg2="${my.hostname}"/>
            <then>
                <echo>Proceeding with install...</echo>
                <antcall target="driver"/>
            </then>
            <else>
                <echo>The installer was run in remote-config mode.  If you wish to run the installer with the configuration in ant.install.properties, edit it and set remote-config = false.</echo>
            </else>
        </if>
    </target>

    <target name="driver" depends="initialize-run-targets, set-resource-tokens, set-postgres-platform-specific-properties, set-oracle-platform-specific-properties, set-sqlserver-platform-specific-properties, set-mysql-platform-specific-properties">
        <antcall target="check-java-version"/>
        <antcall target="dump-properties"/>
        <antcall target="create-uportal-properties"/>

        <if>
            <isset property="run.uportal.deploy"/>
            <then>
                <antcall target="deploy-uportal"/>
            </then>
        </if>

        <available property="portal.webapp.home.exists" file="${portal.webapp.home}"/>
        <fail message="uPortal deployment does not exist as specified by portal.webapp.home=${portal.webapp.home}" unless="portal.webapp.home.exists"/>


        <if>
            <isset property="run.uportal.deploy.testsuite.portlet"/>
            <then>
                <antcall target="uportal-deploy-testsuite-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.uportal.deploy.proxyportlet.portlet"/>
            <then>
                <antcall target="uportal-deploy-proxyportlet-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.uportal.deploy.bookmarks.portlet"/>
            <then>
                <antcall target="uportal-deploy-bookmarks-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.uportal.deploy.rss.portlet"/>
            <then>
                <antcall target="uportal-deploy-rss-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.uportal.deploy.google.portlet"/>
            <then>
                <antcall target="uportal-deploy-google-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.toro.common"/>
            <then>
                <antcall target="deploy-toro-common"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.portlets.common"/>
            <then>
                <antcall target="deploy-portlets-common"/>
                <antcall target="deploy-portlets-common-webapp"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.briefcase.portlet"/>
            <then>
                <antcall target="deploy-briefcase-portlet"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.messaging.portlet"/>
            <then>
                <antcall target="deploy-messaging-portlet"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.gateway.portlet"/>
            <then>
                <antcall target="deploy-gateway-portlet"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.web.content.portlet"/>
            <then>
                <antcall target="deploy-web-content-portlet"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.permissions.portlet"/>
            <then>
                <antcall target="deploy-permissions-portlet"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.blojsom.portlet"/>
            <then>
                <antcall target="deploy-blojsom"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.channel.common"/>
            <then>
                <antcall target="deploy-channels-common"/>
            </then>
        </if>

        <if>
            <isset property="run.ldap.merge"/>
            <then>
                <antcall target="ldap-merge"/>
            </then>
        </if>

        <if>
            <isset property="run.deploy.bookmarks.channel"/>
            <then>
                <antcall target="deploy-bookmarks-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.calendar.channel"/>
            <then>
                <antcall target="deploy-calendar-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.campusannouncement.channel"/>
            <then>
                <antcall target="deploy-campusannouncement-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.classifieds.channel"/>
            <then>
                <antcall target="deploy-classifieds-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.ldapchangepw.channel"/>
            <then>
                <antcall target="deploy-ldapchangepw-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.login.channel"/>
            <then>
                <antcall target="deploy-login-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.news.channel"/>
            <then>
                <antcall target="deploy-news-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.notes.channel"/>
            <then>
                <antcall target="deploy-notes-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.survey.channel"/>
            <then>
                <antcall target="deploy-survey-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.useradmin.channel"/>
            <then>
                <antcall target="deploy-useradmin-channel"/>
            </then>
        </if>
        <if>
            <isset property="run.deploy.cms.channel"/>
            <then>
                <antcall target="deploy-cms-channel"/>
            </then>
        </if>

        <antcall target="initialize"/>

    </target>


   <target name="initialize">
      <copy file="${basedir}/properties/hibernate.properties" todir="${work.dir}" filtering="on">
        <filterset refId="tokens"/>
        <filterset>
          <filter token="hibernate.dialect" value="${hibernate.dialect}"/>
        </filterset>
      </copy>

      <if>
          <isset property="run.uportal.db"/>
          <then>
              <antcall target="uportal-load-db"/>
          </then>
      </if>
      <if>
          <isset property="run.uportal.pubchan"/>
          <then>
              <antcall target="uportal-pubchan"/>
          </then>
      </if>
      <if>
          <isset property="run.uportal.i18n.db"/>
          <then>
              <antcall target="uportal-i18n-db"/>
          </then>
      </if>
      <if>
          <isset property="run.uportal.pubfragments"/>
          <then>
              <antcall target="uportal-pubfragments">
                  <param name="fragmentFile" value="/properties/al/fragments.xml"/>
              </antcall>
          </then>
      </if>

      <antcall target="uportal-add-additional-constraints"/>

      <if>
          <isset property="run.dbloader.toro.common"/>
          <then>
              <antcall target="initialize-toro-common"/>
          </then>
      </if>

      <if>
          <isset property="run.hibernate.alchemist"/>
          <then>
              <antcall target="initialize-alchemist"/>
          </then>
      </if>
      <if>
          <isset property="run.hibernate.demetrius"/>
          <then>
              <antcall target="initialize-demetrius"/>
          </then>
      </if>
      <if>
          <isset property="run.hibernate.mercury"/>
          <then>
              <antcall target="initialize-mercury"/>
          </then>
      </if>
      <if>
          <isset property="run.hibernate.portlets-common"/>
          <then>
              <antcall target="initialize-portlets-common"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.cdk"/>
          <then>
              <antcall target="initialize-cdk"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.survey"/>
          <then>
              <antcall target="initialize-survey"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.news"/>
          <then>
              <antcall target="initialize-news"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.classifieds"/>
          <then>
              <antcall target="initialize-classifieds"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.calendar"/>
          <then>
              <antcall target="initialize-calendar"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.notes"/>
          <then>
              <antcall target="initialize-notes"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.bookmarks"/>
          <then>
              <antcall target="initialize-bookmarks"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.campusannouncement"/>
          <then>
              <antcall target="initialize-campusannouncement"/>
          </then>
      </if>
      <if>
          <isset property="run.dbloader.cms"/>
          <then>
              <antcall target="initialize-cms"/>
          </then>
      </if>

      <property name="uportal.pubchan" value="true"/>

      <if>
          <isset property="run.publish.common.channels"/>
          <then>
              <antcall target="publish-addressbook"/>
              <antcall target="publish-systray"/>
          </then>
      </if>

      <if>
          <isset property="run.publish.briefcase.portlet"/>
          <then>
              <antcall target="publish-briefcase-portlet"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.gateway.portlet"/>
          <then>
              <antcall target="publish-gateway-portlet"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.messaging.portlet"/>
          <then>
              <antcall target="publish-messaging-portlet"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.permissions.portlet"/>
          <then>
              <antcall target="publish-permissions-portlet"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.web.content.portlet"/>
          <then>
              <antcall target="publish-web-content-portlet"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.survey.channel"/>
          <then>
              <antcall target="publish-survey"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.news.channel"/>
          <then>
              <antcall target="publish-news"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.classifieds.channel"/>
          <then>
              <antcall target="publish-classifieds"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.calendar.channel"/>
          <then>
              <antcall target="publish-calendar"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.login.channel"/>
          <then>
              <antcall target="publish-login"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.notes.channel"/>
          <then>
              <antcall target="publish-notes"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.bookmarks.channel"/>
          <then>
              <antcall target="publish-bookmarks"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.campusannouncement.channel"/>
          <then>
              <antcall target="publish-campusannouncement"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.ldapchangepw.channel"/>
          <then>
              <antcall target="publish-ldapchangepw"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.useradmin.channel"/>
          <then>
              <antcall target="publish-useradmin"/>
          </then>
      </if>
      <if>
          <isset property="run.publish.cms.channel"/>
          <then>
              <antcall target="publish-cms"/>
          </then>
      </if>
    </target>
    <!--  End Driver targets  -->

    <!-- Maven Utilities -->
    <target name="copy-maven-artifact-to-file">
        <echo>Copying maven artifact ${groupId}:${artifactId}:${version}:${archive.type} to ${tofile}</echo>
        <artifact:dependencies filesetId="copy-maven-artifact.filesetId">
            <dependency groupId="${groupId}" artifactId="${artifactId}"
                version="${version}" type="${archive.type}"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <copy tofile="${tofile}">
            <fileset refId="copy-maven-artifact.filesetId"/>
        </copy>
    </target>

    <target name="copy-maven-artifact-to-dir">
        <echo>Copying maven artifact ${groupId}:${artifactId}:${version}:${archive.type} to ${todir}</echo>
        <artifact:dependencies filesetId="copy-maven-artifact.filesetId">
            <dependency groupId="${groupId}" artifactId="${artifactId}"
                version="${version}" type="${archive.type}"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <copy flatten="true" todir="${todir}">
            <fileset refId="copy-maven-artifact.filesetId"/>
        </copy>
    </target>

   <target name="extract-artifact">
       <available property="artifact.exists" file="${artifact.path}"/>
       <condition property="ok.to.extract.artifact">
           <or>
               <contains string="${version}" substring="SNAPSHOT"/>
               <not><available file="${target.dir}/.artifact_extracted"/></not>
           </or>
       </condition>
       <antcall target="extract-artifact-task">
           <param name="groupId" value="${groupId}"/>
           <param name="artifactId" value="${artifactId}"/>
           <param name="version" value="${version}"/>
           <param name="target.dir" value="${target.dir}"/>
           <param name="archive.type" value="${archive.type}"/>
           <param name="remote.repository" value="${remote.repository}"/>
       </antcall>
       <touch file="${target.dir}/.artifact_extracted"/>
   </target>

   <target name="extract-artifact-task" if="ok.to.extract.artifact">
        <echo>Extracting maven artifact ${groupId}:${artifactId}:${version}:${archive.type} to ${target.dir}</echo>
       <artifact:dependencies filesetId="extract-artifact-task.filesetId">
           <dependency groupId="${groupId}" artifactId="${artifactId}"
               version="${version}" type="${archive.type}"/>
           <remoteRepository refid="${remote.repository}" />
           <!--include name="**/${artifactId}-${version}.${archive.type}"/-->
       </artifact:dependencies>
       <unjar dest="${target.dir}">
           <fileset refId="extract-artifact-task.filesetId"/>
       </unjar>
   </target>
    <!-- End Maven Utilities -->

    <!-- Common Utilities -->
    <target name="deploy-filtered">
        <antcall target="extract-artifact">
          <param name="groupId" value="${groupId}"/>
          <param name="artifactId" value="${artifactId}"/>
          <param name="version" value="${version}"/>
          <param name="target.dir" value="${tmpdir}"/>
          <param name="archive.type" value="${archive.type}"/>
          <param name="remote.repository" value="${remote.repository}"/>
        </antcall>
        <copy todir="${dest}" filtering="on">
            <fileset dir="${tmpdir}">
                <include name="**/*.xml"/>
                <include name="**/*.properties"/>
            </fileset>
            <filterset refid="tokens"/>
            <filterset>
                <filter token="webappName" value="${webappName}"/>
            </filterset>
        </copy>
        <copy todir="${dest}">
            <fileset dir="${tmpdir}">
                <exclude name="**/*.xml"/>
                <exclude name="**/*.properties"/>
            </fileset>
        </copy>
    </target>

    <target name="deploy-toro-jar">
        <antcall target="deploy-jar">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${project.version}"/>
            <param name="todir" value="${todir}"/>
            <param name="exclusions" value="${exclusions}"/>
        </antcall>
    </target>

    <target name="deploy-jar">
        <antcall target="copy-maven-artifact-to-dir">
            <param name="groupId" value="${groupId}"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${version}"/>
            <param name="archive.type" value="jar"/>
            <param name="todir" value="${todir}"/>
            <param name="exclusions" value="${exclusions}"/>
        </antcall>
    </target>

    <target name="deploy-toro-war">
        <antcall target="deploy-war">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${project.version}"/>
            <param name="webappName" value="${webappName}"/>
            <param name="maven.repo" value="toro.repository"/>
        </antcall>
    </target>

    <target name="deploy-war">
        <artifact:dependencies pathId="${artifactId}.war">
            <dependency groupId="${groupId}" artifactId="${artifactId}"
                version="${project.version}" type="war"/>
            <remoteRepository refid="${maven.repo}" />
        </artifact:dependencies>
        <antcall target="deploy-filtered">
            <param name="groupId" value="${groupId}"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${project.version}"/>
            <param name="archive.type" value="war"/>
            <param name="dest" value="${webapp.home}/${webappName}"/>
            <param name="tmpdir" value="${work.dir}/${artifactId}-${project.version}"/>
            <param name="webappName" value="${webappName}"/>
            <param name="remote.repository" value="toro.repository"/>
        </antcall>
    </target>

    <target name="merge-configuration">
        <artifact:dependencies pathId="configuration.classpath">
            <dependency groupId="net.unicon.toro" artifactId="alchemist"
                version="${project.version}" type="jar"/>
            <dependency groupId="jetspeed" artifactId="jetspeed"
                version="${jetspeed.version}" type="jar"/>
            <dependency groupId="jaxen" artifactId="jaxen"
                version="${jaxen.version}" type="jar"/>
            <dependency groupId="dom4j" artifactId="dom4j"
                version="${dom4j.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <echo>MergeConfiguration configfile=${configfile} targetdir=${targetdir}</echo>
        <java failonerror="true" fork="true" dir="${basedir}" classname="net.unicon.alchemist.tools.MergeConfiguration">
            <classpath refid="configuration.classpath"/>
            <classpath>
                <pathelement path="${work.dir}/uportal-properties"/>
            </classpath>
            <arg line="${configfile} ${targetdir}"/>    
        </java>
    </target>

    <target name="run-hbm2dll">
        <echo>Creating schema for ${groupId}:${artifactId}:${version} with create.only option: #${hibernate.create.only}#</echo>
        <artifact:dependencies pathId="hibernate.classpath">
            <dependency groupId="org.hibernate" artifactId="hibernate"
                version="${hibernate.version}" type="jar"/>
            <dependency groupId="${groupId}" artifactId="${artifactId}"
                version="${version}" type="jar"/>
            <dependency groupId="xerces" artifactId="xercesImpl"
                version="${xercesImpl.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <java classname="org.hibernate.tool.hbm2ddl.SchemaExport">
            <arg line="--config=/hibernate.cfg.xml --properties=${work.dir}/hibernate.properties ${hibernate.create.only}"/>
            <classpath>
                <path refid="db.classpath"/>
                <path refid="hibernate.classpath"/>
            </classpath>
        </java>
    </target>

    <target name="backup-original-file">
    </target>
    <!-- End Common Utilities -->

    <target name="deploy-toro-common">
        <mkdir dir="${toro.data.home}" /> 
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-common"/>
        </antcall>
        <copy overwrite="true" file="${basedir}/properties/uPortal-${uportal.version}/xhtml-theme.xsl"
            todir="${portal.webapp.home}/WEB-INF/classes/org/jasig/portal/layout/tab-column/xhtml-theme"/>
        <copy overwrite="true" outputencoding="utf-8" file="${basedir}/properties/uPortal-${uportal.version}/ajax-preferences.js"
            todir="${portal.webapp.home}/WEB-INF/classes/org/jasig/portal/layout/tab-column/xhtml-theme/common"/>
        <antcall target="common-add-uportal-configurations"/>

        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-systray-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-systray-channel"/>
        </antcall>
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="resource-pool"/>
            <param name="todir" value="${tomcat.home}/shared/lib"/>
        </antcall>
    </target>


    <!-- Portlet Targets -->
    <target name="deploy-portlets-common">
        <antcall target="deploy-toro-jar"> 
            <param name="artifactId" value="academus-api"/>
            <param name="todir" value="${tomcat.home}/shared/lib"/>
        </antcall>
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="sso-authentication-cache"/>
            <param name="todir" value="${tomcat.home}/shared/lib"/>
        </antcall>
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="uportal-academus-api"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
            <param name="exclusions" value="&lt;exclusions>&lt;exclusion>&lt;groupId>uportal&lt;/groupId>&lt;artifactId>uportal&lt;/artifactId>&lt;/exclusion>&lt;/exclusions>"/>
        </antcall>
        <artifact:dependencies filesetId="messaging-portlet.fileset">
            <dependency groupId="net.unicon.toro" artifactId="messaging-portlet" version="${project.version}" type="war"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <unjar dest="${work.dir}/toro-portlets-common">
            <fileset refid="messaging-portlet.fileset"/>
            <patternset>
                <include name="WEB-INF/classes/config/messaging-portlet.xml"/>
            </patternset>
        </unjar>
        <copy overwrite="yes" filtering="on" todir="${tomcat.home}/webapps/toro-portlets-common">
            <fileset dir="${work.dir}/toro-portlets-common"/>
            <filterset refid="tokens"/>
        </copy>
    </target> 

    <target name="deploy-portlet">
        <echo>Deploying maven artifact net.unicon.toro:${artifactId}:${project.version}:war to ${webapp.home}/${webappName}</echo>
        <artifact:dependencies pathId="deployPortlet.classpath">
            <dependency groupId="net.unicon.toro" artifactId="${artifactId}" version="${project.version}" type="war"/>
            <dependency groupId="net.unicon.toro" artifactId="portlets-common-lib" version="${project.version}" type="jar"/>
            <dependency groupId="uportal" artifactId="uportal" version="${uportal.version}" type="jar"/>
            <dependency groupId="org.apache.pluto" artifactId="pluto" version="${pluto.version}" type="jar"/>
            <dependency groupId="commons-logging" artifactId="commons-logging" version="${commons-logging.version}" type="jar"/>
            <dependency groupId="portlet-api" artifactId="portlet-api" version="${portlet-api.version}" type="jar"/>
            <dependency groupId="xerces" artifactId="xercesImpl" version="${xercesImpl.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <delete dir="${webapp.home}/${webappName}"/>
        <delete dir="${work.dir}/${webappName}.war"/>
        <antcall target="copy-maven-artifact-to-file">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${project.version}"/>
            <param name="archive.type" value="war"/>
            <param name="tofile" value="${work.dir}/${webappName}.war"/>
        </antcall>
        <echo message="war: ${work.dir}/${webappName}-${project.version}.war"/>
        <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.container.deploy.Deployer">
            <classpath refid="deployPortlet.classpath" />
            <arg value="${work.dir}"/>
            <arg value="${work.dir}/${webappName}.war"/>
        </java>
        <artifact:dependencies filesetId="portlets-common-rendering.filesetId">
            <dependency groupId="net.unicon.toro" artifactId="portlets-common-lib"
                version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <unjar dest="${work.dir}/${webappName}">
            <fileset refId="portlets-common-rendering.filesetId"/>
            <patternset>
                <include name="rendering/**"/>
            </patternset>
        </unjar>
        <copy todir="${webapp.home}/${webappName}" filtering="on">
            <fileset dir="${work.dir}/${webappName}">
                <include name="**/*.xml"/>
                <include name="**/*.properties"/>
            </fileset>
            <filterset refid="tokens"/>
        </copy>
        <copy todir="${webapp.home}/${webappName}" filtering="off">
            <fileset dir="${work.dir}/${webappName}">
                <exclude name="**/*.xml"/>
                <exclude name="**/*.properties"/>
            </fileset>
        </copy>
        <copy tofile="${tomcat.host.conf}/${webappName}.xml" file="properties/${webappName}.xml">
            <filterset refid="tokens"/>
            <filterset>
                <filter token="webappName" value="${webappName}"/>
            </filterset>
        </copy>
    </target>


    <target name="clean-portlets" depends="
        clean-briefcase-portlet,
        clean-messaging-portlet,
        clean-gateway-portlet,
        clean-web-content-portlet,
        clean-permissions-portlet,
        clean-blojsom
        "/>

    <target name="deploy-portlets-common-webapp">
        <antcall target="deploy-toro-war">
            <param name="webappName" value="toro-portlets-common"/>
            <param name="artifactId" value="portlets-common-webapp"/>
        </antcall>
    </target>

    <target name="common-add-uportal-configurations">
        <copy filtering="on" todir="${work.dir}/common-add-uportal-configurations" file="${basedir}/properties/uPortal-${uportal.version}/common-uPortalConfigurationChanges.xml">
            <filterset refid="tokens"/>
        </copy>
        <antcall target="merge-configuration">
            <param name="configfile" value="${work.dir}/common-add-uportal-configurations/common-uPortalConfigurationChanges.xml"/>
            <param name="targetdir" value="${portal.webapp.home}"/>
        </antcall>
    </target>

    <target name="ldap-merge">
        <copy filtering="on" todir="${work.dir}/ldap-merge" file="${basedir}/properties/uPortal-${uportal.version}/ldap-merge-configuration.xml">
            <filterset refid="tokens"/>
        </copy>
        <antcall target="merge-configuration">
            <param name="configfile" value="${work.dir}/ldap-merge/ldap-merge-configuration.xml"/>
            <param name="targetdir" value="${portal.webapp.home}"/>
        </antcall>

        <copy filtering="on" todir="${work.dir}/ldap-merge" file="${basedir}/properties/uPortal-${uportal.version}/personDirectory-bean-merge-configuration.xml">
            <filterset refid="tokens"/>
        </copy>
        <antcall target="merge-configuration">
            <param name="configfile" value="${work.dir}/ldap-merge/personDirectory-bean-merge-configuration.xml"/>
            <param name="targetdir" value="${portal.webapp.home}"/>
        </antcall>

        <taskdef name="gen-security-context-props" classname="net.unicon.toro.installer.anttask.GenerateSecurityContextProperties" classpath="${basedir}"/>
        <gen-security-context-props/>
        <copy filtering="on" todir="${work.dir}/ldap-merge" file="${basedir}/properties/uPortal-${uportal.version}/security-context-bean-merge-configuration.xml">
            <filterset refid="tokens"/>
            <filterset>
                <filter token="ldap.security.comment" value="${ldap.security.comment}"/>
                <filter token="ldap2.security.comment" value="${ldap2.security.comment}"/>
                <filter token="ldap3.security.comment" value="${ldap3.security.comment}"/>
                <filter token="ldap4.security.comment" value="${ldap4.security.comment}"/>
                <filter token="ldap.name.security" value="${ldap.name.security}"/>
                <filter token="ldap2.name.security" value="${ldap2.name.security}"/>
                <filter token="ldap3.name.security" value="${ldap3.name.security}"/>
                <filter token="ldap4.name.security" value="${ldap4.name.security}"/>
            </filterset>
        </copy>
        <antcall target="merge-configuration">
            <param name="configfile" value="${work.dir}/ldap-merge/security-context-bean-merge-configuration.xml"/>
            <param name="targetdir" value="${portal.webapp.home}"/>
        </antcall>
    </target>

    <target name="deploy-briefcase-portlet">
        <echo>Deploying Briefcase Portlet</echo>
        <antcall target="deploy-portlet">
            <param name="artifactId" value="briefcase-portlet"/>
            <param name="webappName" value="toro-briefcase-portlet"/>
        </antcall>
    </target>

    <target name="clean-briefcase-portlet" if="briefcase-portlet.active">
        <echo>Cleaning Briefcase Portlet</echo>
        <delete dir="${webapp.home}/toro-briefcase-portlet"/>
    </target>

    <target name="deploy-messaging-portlet">
        <echo>Deploying Messaging Portlet</echo>
        <antcall target="deploy-portlet">
            <param name="artifactId" value="messaging-portlet"/>
            <param name="webappName" value="toro-messaging-portlet"/>
        </antcall>
    </target>

    <target name="clean-messaging-portlet" if="messaging-portlet.active">
        <echo>Cleaning Messaging Portlet</echo>
        <delete dir="${webapp.home}/toro-messaging-portlet"/>
    </target>

    <target name="deploy-permissions-portlet">
        <echo>Deploying Permissions Portlet</echo>
        <antcall target="deploy-portlet">
            <param name="artifactId" value="permissions-portlet"/>
            <param name="webappName" value="toro-permissions-portlet"/>
        </antcall>

        <!-- add the descriptor for each deployed portlet -->
        <available file="${webapp.home}/toro-briefcase-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml" property="toro-briefcase-portlet.present"/>
        <antcall target="merge-permissions-descriptor-for-briefcase"/>
        <available file="${webapp.home}/toro-messaging-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml" property="toro-messaging-portlet.present"/>
        <antcall target="merge-permissions-descriptor-for-messaging"/>
        <available file="${webapp.home}/toro-gateway-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml" property="toro-gateway-portlet.present"/>
        <antcall target="merge-permissions-descriptor-for-gateway"/>
        <available file="${webapp.home}/toro-web-content-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml" property="toro-web-content-portlet.present"/>
        <antcall target="merge-permissions-descriptor-for-web-content"/>
    </target>

    <target name="deploy-gateway-portlet">
        <echo>Deploying Gateway Portlet</echo>
        <antcall target="deploy-portlet">
            <param name="artifactId" value="gateway-portlet"/>
            <param name="webappName" value="toro-gateway-portlet"/>
        </antcall>
    </target>

    <target name="clean-gateway-portlet" if="gateway-portlet.active">
        <echo>Cleaning Gateway Portlet</echo>
        <delete dir="${webapp.home}/toro-gateway-portlet"/>
    </target>

    <target name="deploy-web-content-portlet">
        <echo>Deploying Web Content Portlet</echo>
        <antcall target="deploy-portlet">
            <param name="artifactId" value="web-content-portlet"/>
            <param name="webappName" value="toro-web-content-portlet"/>
        </antcall>
    </target>

    <target name="clean-web-content-portlet" if="web-content-portlet.active">
        <echo>Cleaning Web Content Portlet</echo>
        <delete dir="${webapp.home}/toro-web-content-portlet"/>
    </target>

    <target name="deploy-blojsom">
        <echo>Deploying Blojsom</echo>
        <antcall target="deploy-toro-war">
            <param name="webappName" value="toro-blojsom"/>
            <param name="artifactId" value="blojsom"/>
        </antcall>
        <property name="gateway-portlet.active" value="yes"/>
        <antcall target="deploy-gateway-portlet"/>
        <copy tofile="${tomcat.host.conf}/toro-blojsom.xml" file="properties/toro-blojsom.xml">
            <filterset refid="tokens"/>
            <filterset>
                <filter token="webappName" value="toro-blojsom"/>
            </filterset>
        </copy>
    </target>

    <target name="clean-blojsom" if="blojsom.active">
        <echo>Cleaning Blojsom</echo>
        <delete dir="${webapp.home}/toro-blojsom"/>
        <property name="gateway-portlet.active" value="yes"/>
        <antcall target="clean-gateway-portlet"/>
    </target>

    <target name="merge-permissions-descriptor-for-briefcase" if="toro-briefcase-portlet.present">
        <echo>Merging permissions descriptor for briefcase</echo>
        <loadfile property="replaceValue" srcFile="${webapp.home}/toro-briefcase-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml"/>
        <replace file="${webapp.home}/toro-permissions-portlet/WEB-INF/classes/config/permissions-portlet.xml" token="briefcase-portlet-section-->" value="${replaceValue}"/>
    </target>

    <target name="merge-permissions-descriptor-for-messaging" if="toro-messaging-portlet.present">
        <echo>Merging permissions descriptor for messaging</echo>
        <loadfile property="replaceValue" srcFile="${webapp.home}/toro-messaging-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml"/>
        <replace file="${webapp.home}/toro-permissions-portlet/WEB-INF/classes/config/permissions-portlet.xml" token="messaging-portlet-section-->" value="${replaceValue}"/>
    </target>

    <target name="merge-permissions-descriptor-for-gateway" if="toro-gateway-portlet.present">
        <echo>Merging permissions descriptor for gateway</echo>
        <loadfile property="replaceValue" srcFile="${webapp.home}/toro-gateway-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml"/>
        <replace file="${webapp.home}/toro-permissions-portlet/WEB-INF/classes/config/permissions-portlet.xml" token="gateway-portlet-section-->" value="${replaceValue}"/>
    </target>

    <target name="merge-permissions-descriptor-for-web-content" if="toro-web-content-portlet.present">
        <echo>Merging permissions descriptor for web content</echo>
        <loadfile property="replaceValue" srcFile="${webapp.home}/toro-web-content-portlet/WEB-INF/classes/config/permissions-portlet-fragment.xml"/>
        <replace file="${webapp.home}/toro-permissions-portlet/WEB-INF/classes/config/permissions-portlet.xml" token="web-content-portlet-section-->" value="${replaceValue}"/>
    </target>

    <target name="clean-permissions-portlet" if="permissions-portlet.active">
        <echo>Cleaning Permissions Portlet</echo>
        <delete dir="${webapp.home}/toro-permissions-portlet"/>
    </target>

    <target name="publish-briefcase-portlet">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="briefcase-lib"/>
            <param name="channel" value="briefcase-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-gateway-portlet">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="gateway-lib"/>
            <param name="channel" value="gateway-blogger-channel-publish.xml"/>
        </antcall>
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="gateway-lib"/>
            <param name="channel" value="gateway-example-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-messaging-portlet">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="messaging-lib"/>
            <param name="channel" value="messaging-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-permissions-portlet">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="permissions-lib"/>
            <param name="channel" value="permissions-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-web-content-portlet">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="web-content-lib"/>
            <param name="channel" value="web-content-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="initialize-alchemist">
        <echo>Initializing Alchemist</echo>
        <antcall target="run-hbm2dll">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="alchemist"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-demetrius">
        <echo>Initializing Demetrius</echo>
        <antcall target="run-hbm2dll">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="demetrius"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-mercury">
        <echo>Initializing Mercury</echo>
        <antcall target="run-hbm2dll">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="mercury"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-portlets-common">
        <echo>Initializing Portlets Common</echo>
        <antcall target="run-hbm2dll">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="portlets-common-lib"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>
    <!-- End Portlet Targets -->

    <!-- Channel Targets -->
    <target name="deploy-channels-common">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-addressbook-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-addressbook-channel"/>
        </antcall>
        <antcall target="merge-uportal-configurations">
            <param name="artifactId" value="cdk"/>
        </antcall>
    </target>

    <target name="merge-uportal-configurations">
        <artifact:dependencies filesetId="merge-uportal-configurations.filesetId">
            <dependency groupId="net.unicon.toro" artifactId="${artifactId}" version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <unjar dest="${work.dir}/${artifactId}-uportal-configurations">
            <fileset refId="merge-uportal-configurations.filesetId"/>
            <patternset>
                <include name="uportal-configuration-merges/**"/>
            </patternset>
        </unjar>
        <antcall target="merge-configuration">
            <param name="configfile" value="${work.dir}/${artifactId}-uportal-configurations/uportal-configuration-merges/uportal-configuration-merges.xml"/>
            <param name="targetdir" value="${portal.webapp.home}"/>
        </antcall>
    </target>

    <target name="extract-resources">
        <available property="resources.exists" file="${artifact.path}"/>
        <condition property="ok.to.extract.resources">
            <or>
                <contains string="${version}" substring="SNAPSHOT"/>
                <not><available file="${target.dir}/.artifact_extracted"/></not>
            </or>
        </condition>
        <antcall target="extract-resources-task">
            <param name="groupId" value="${groupId}"/>
            <param name="artifactId" value="${artifactId}"/>
            <param name="version" value="${version}"/>
            <param name="target.dir" value="${target.dir}"/>
            <param name="archive.type" value="${archive.type}"/>
            <param name="remote.repository" value="${remote.repository}"/>
        </antcall>
        <touch file="${target.dir}/.artifact_extracted"/>
    </target>

     <target name="extract-resources-task" if="ok.to.extract.resources">
         <echo>Extracting resources ${groupId}:${artifactId}:${version}:${archive.type} to ${target.dir}</echo>
        <artifact:dependencies filesetId="extract-resources-task.filesetId">
            <dependency groupId="${groupId}" artifactId="${artifactId}"
                version="${version}" type="${archive.type}"/>
            <remoteRepository refid="${remote.repository}" />
            <!--include name="**/${artifactId}-${version}.${archive.type}"/-->
        </artifact:dependencies>
        <unjar dest="${target.dir}">
            <fileset refId="extract-resources-task.filesetId"/>
             <patternset>
                 <include name="*.jsp"/>
                 <include name="*.html"/>
                 <include name="*.html"/>
                 <include name="WEB-INF/**"/>
                 <include name="html/**"/>
                 <include name="templates/**"/>
                 <include name="wml/**"/>
                 <include name="javascript/**"/>
                 <include name="media/**"/>
             </patternset>
        </unjar>
    </target>

    <target name="deploy-toro-resources">
        <antcall target="extract-artifact">
          <param name="groupId" value="net.unicon.toro"/>
          <param name="artifactId" value="${artifactId}"/>
          <param name="version" value="${project.version}"/>
          <param name="target.dir" value="${work.dir}/${artifactId}-resources"/>
          <param name="archive.type" value="jar"/>
          <param name="remote.repository" value="uportal.repository"/>
        </antcall>
        <copy overwrite="true" todir="${portal.webapp.home}">
            <fileset dir="${work.dir}/${artifactId}-resources">
                 <patternset>
                     <include name="media/**"/>
                 </patternset>
             </fileset>
        </copy>
        <copy filtering="on" overwrite="true" todir="${portal.webapp.home}">
            <fileset dir="${work.dir}/${artifactId}-resources">
                 <patternset>
                     <include name="*.jsp"/>
                     <include name="*.html"/>
                     <include name="*.html"/>
                     <include name="WEB-INF/**"/>
                     <include name="html/**"/>
                     <include name="templates/**"/>
                     <include name="wml/**"/>
                     <include name="javascript/**"/>
                 </patternset>
             </fileset>
            <filterset refid="tokens"/>
        </copy>
    </target>

    <target name="deploy-survey-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-survey-channel"/>
        </antcall>
        <mkdir dir="${toro.data.home}/survey"/>
        <antcall target="merge-uportal-configurations">
            <param name="artifactId" value="toro-survey-channel"/>
        </antcall>
    </target>

    <target name="deploy-cms-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-cms-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-cms-channel"/>
        </antcall>
    </target>

    <target name="deploy-news-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-news-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-news-channel"/>
        </antcall>
        <mkdir dir="${toro.data.home}/campus_news"/>
    </target>

    <target name="deploy-classifieds-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-classifieds-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-classifieds-channel"/>
        </antcall>
        <mkdir dir="${toro.data.home}/classifieds"/>
    </target>

    <target name="deploy-calendar-channel">
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-calendar-channel"/>
        </antcall>
    </target>

    <target name="deploy-notes-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-notes-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-notes-channel"/>
        </antcall>
    </target>

    <target name="deploy-bookmarks-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-bookmarks-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-bookmarks-channel"/>
        </antcall>
    </target>

    <target name="deploy-campusannouncement-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-campusannouncement-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-campusannouncement-channel"/>
        </antcall>
    </target>

    <target name="deploy-ldapchangepw-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-ldapchangepw-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-ldapchangepw-channel"/>
        </antcall>
    </target>

    <target name="deploy-useradmin-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-useradmin-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-useradmin-channel"/>
        </antcall>
    </target>

    <target name="deploy-login-channel">
        <antcall target="deploy-toro-jar">
            <param name="artifactId" value="toro-login-channel"/>
            <param name="todir" value="${portal.webapp.home}/WEB-INF/lib"/>
        </antcall>
        <antcall target="deploy-toro-resources">
            <param name="artifactId" value="toro-login-channel"/>
        </antcall>
    </target>

    <target name="initialize-toro-common">
        <echo>Initializing Toro Common</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-common"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-common"/>
            <param name="version" value="${project.version}"/>
            <param name="tables.xml" value="/properties/db/dbloader-tables.xml"/>
        </antcall>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (1, 'personal-resources');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (2, 'shared-resources');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (3, 'notifications-rdbms');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (4, 'personal-resources-t-i');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (5, 'personal-resources-p-i');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (6, 'notifications-t-i');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (7, 'notifications-p-i');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (8, 'blog-default-p');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (9, 'blog-blojsomA-p');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (10, 'blog-blojsomB-p');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (11, 'blog-blojsomC-p');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_CONTROLLER (ACCESS_CONTROLLER_ID, NAME) VALUES (12, 'content-p');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (1, 0, 'admin', 'MSG://net.unicon.academus.apps.messaging.RdbmsMessageFactoryCreator$CreatorRdbmsMessageFactory/notifications/admin', 6);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (2, 1, 'Everyone', 'dummy://net.unicon.alchemist.access.permissions.Dummy/', 7);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (3, 0, 'admin', 'dummy://net.unicon.alchemist.access.permissions.Dummy/', 8);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (4, 0, 'demo', 'MSG://net.unicon.academus.apps.messaging.RdbmsMessageFactoryCreator$CreatorRdbmsMessageFactory/notifications/demo', 6);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (5, 0, 'student', 'MSG://net.unicon.academus.apps.messaging.RdbmsMessageFactoryCreator$CreatorRdbmsMessageFactory/notifications/student', 6);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (6, 0, 'staff', 'MSG://net.unicon.academus.apps.messaging.RdbmsMessageFactoryCreator$CreatorRdbmsMessageFactory/notifications/staff', 6);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (7, 0, 'faculty', 'MSG://net.unicon.academus.apps.messaging.RdbmsMessageFactoryCreator$CreatorRdbmsMessageFactory/notifications/faculty', 6);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_ENTRY (ACCESS_ENTRY_ID, IDENTITY_TYPE, IDENTITY_NAME, TARGET, ACCESS_CONTROLLER_ID) VALUES (8, 1, 'Everyone - Staff - Web Content Managers', 'dummy://net.unicon.alchemist.access.permissions.Dummy/', 12);
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (1, 65536, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (2, 1, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (2, 2, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (2, 3, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (2, 4, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (3, 1, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (3, 2, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (3, 3, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (3, 4, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (4, 65536, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (5, 65536, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (6, 65536, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (7, 65536, 'T');
           ]]>
       </sql>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[
INSERT INTO ACCESS_TYPES (ACCESS_ENTRY_ID, ACCESS_TYPE, STATUS) VALUES (8, 1, 'T');
           ]]>
       </sql>
    </target>

    <target name="initialize-cdk">
        <echo>Initializing CDK</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="cdk"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="cdk"/>
            <param name="version" value="${project.version}"/>
            <param name="tables.xml" value="/properties/db/dbloader-tables.xml"/>
        </antcall>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-addressbook-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-cms">
        <echo>Initializing CMS</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-cms-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>

        <artifact:dependencies fileSetId="cdk.filesetId">
            <dependency groupId="net.unicon.toro" artifactId="cdk"
                        version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <unjar dest="${work.dir}/uportal-properties/properties">
            <fileset refId="cdk.filesetId"/>
            <patternset>
                <include name="**/academus-apps-lms.properties"/>
                <include name="**/academus-apps.properties"/>
                <include name="**/academus-lms.properties"/>
                <include name="**/factoryImpl.properties"/>
                <include name="**/ToroPersonDirs.xml"/>
                <include name="**/unicon-service.properties"/>
                <include name="**/academus-portal.properties"/>
                <include name="**/common-factory.properties"/>
            </patternset>
        </unjar>
        <move filtering="on" todir="${work.dir}/uportal-properties/properties">
            <fileset dir="${work.dir}/uportal-properties/properties/WEB-INF/classes/properties">
                <include name="academus-apps-lms.properties"/>
                <include name="academus-apps.properties"/>
                <include name="academus-lms.properties"/>
                <include name="factoryImpl.properties"/>
                <include name="ToroPersonDirs.xml"/>
                <include name="unicon-service.properties"/>
                <include name="academus-portal.properties"/>
                <include name="common-factory.properties"/>
            </fileset>
            <filterset refid="tokens"/>
        </move>

        <artifact:dependencies pathId="cmsGroupInitialization.classpath">
            <dependency groupId="net.unicon.toro" artifactId="cdk"
                version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <java fork="true" failonerror="true" dir="${work.dir}" classname="net.unicon.toro.installer.tools.CmsGroupInitialization">
          <classpath>
            <pathelement path="${work.dir}/uportal-properties"/>
            <pathelement path="${basedir}"/>
            <path refId="cmsGroupInitialization.classpath"/>
            <path refId="uportal.classpath"/>
            <fileset refId="uportal-jar.fileset"/>
          </classpath>
          <arg value="-n"/>
          <arg value="${channel}"/>
        </java> 

        <artifact:dependencies fileSetId="data.loader.file">
           <dependency groupId="net.unicon.toro" artifactId="toro-cms-channel"
                       version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
       </artifact:dependencies>
       <unjar dest="${work.dir}">
           <fileset refId="data.loader.file"/>
           <patternset>
               <include name="**/dbloader-uportal-data.xml"/>
           </patternset>
       </unjar>
       <move filtering="on" file="${work.dir}/dbloader-uportal-data.xml" todir="${work.dir}/uportal-properties/properties/db">
           <filterset>
               <filtersfile file="${work.dir}/roleGroupKeys.properties"/>
           </filterset>
       </move>
       <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
           <classpath>
               <pathelement path="${work.dir}/uportal-properties"/>
               <fileset refId="uportal-jar.fileset"/>
               <path refId="uportal.classpath"/>
           </classpath>

           <arg line="-nD -nC -P -t /properties/db/tables.xml -d /properties/db/dbloader-uportal-data.xml"/>
       </java>
    </target>

    <target name="initialize-survey">
        <echo>Initializing Survey Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="data.xml" value="/properties/db/dbloader-uportal-data.xml"/>
        </antcall>
    </target>

    <target name="initialize-news">
        <echo>Initializing News Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-news-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-news-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="data.xml" value="/properties/db/dbloader-uportal-data.xml"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-news-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="tables.xml" value="/properties/db/dbloader-tables.xml"/>
        </antcall>
    </target>

    <target name="initialize-classifieds">
        <echo>Initializing Classifieds Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-classifieds-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-classifieds-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="data.xml" value="/properties/db/dbloader-uportal-data.xml"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-classifieds-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="tables.xml" value="/properties/db/dbloader-tables.xml"/>
        </antcall>
    </target>

    <target name="initialize-calendar">
        <echo>Initializing Calendar Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-calendar-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
        <antcall target="uportal-dbloader-data">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-calendar-channel"/>
            <param name="version" value="${project.version}"/>
            <param name="data.xml" value="/properties/db/dbloader-uportal-data.xml"/>
        </antcall>
    </target>

    <target name="initialize-notes">
        <echo>Initializing Notes Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-notes-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-bookmarks">
        <echo>Initializing Bookmarks Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-bookmarks-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="initialize-campusannouncement">
        <echo>Initializing Campus Announcements Channel</echo>
        <antcall target="uportal-dbloader-tables">
            <param name="groupId" value="net.unicon.toro"/>
            <param name="artifactId" value="toro-campusannouncement-channel"/>
            <param name="version" value="${project.version}"/>
        </antcall>
    </target>

    <target name="publish-systray">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-systray-channel"/>
            <param name="channel" value="systray-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-addressbook">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-addressbook-channel"/>
            <param name="channel" value="addressbook-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-cms">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-cms-channel"/>
            <param name="channel" value="cms-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-survey">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="channel" value="poll-channel-publish.xml"/>
        </antcall>
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="channel" value="survey-channel-publish.xml"/>
        </antcall>
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-survey-channel"/>
            <param name="channel" value="survey-author-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-news">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-news-channel"/>
            <param name="channel" value="news-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-classifieds">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-classifieds-channel"/>
            <param name="channel" value="classifieds-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-calendar">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-calendar-channel"/>
            <param name="channel" value="calendar-channel-publish.xml"/>
        </antcall>
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-calendar-channel"/>
            <param name="channel" value="calendar-events-channel-publish.xml"/>
        </antcall>
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-calendar-channel"/>
            <param name="channel" value="calendar-tasks-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-notes">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-notes-channel"/>
            <param name="channel" value="notes-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-bookmarks">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-bookmarks-channel"/>
            <param name="channel" value="bookmarks-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-campusannouncement">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-campusannouncement-channel"/>
            <param name="channel" value="campusannouncement-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-ldapchangepw">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-ldapchangepw-channel"/>
            <param name="channel" value="ldapchangepw-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-useradmin">
        <antcall target="publish-toro-channel">
            <param name="artifactId" value="toro-useradmin-channel"/>
            <param name="channel" value="useradmin-channel-publish.xml"/>
        </antcall>
    </target>

    <target name="publish-login">
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>

           <![CDATA[update up_channel set chan_class='net.unicon.portal.channels.login.CLogin' where chan_id=99;]]>
       </sql>
    </target>

    <target name="publish-toro-channel">
        <echo>Publishing channel net.unicon.toro:${artifactId}:${project.version}:jar</echo>
        <artifact:dependencies pathId="publish-toro-channel.classpath">
            <dependency groupId="net.unicon.toro" artifactId="${artifactId}"
                version="${project.version}" type="jar"/>
            <remoteRepository refid="toro.repository" />
        </artifact:dependencies>
        <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.chanpub.ChannelPublisher">
          <classpath>
            <path refId="publish-toro-channel.classpath"/>
            <pathelement path="${work.dir}/uportal-properties"/>
            <pathelement path="${work.dir}/${upPublishArtifactId}-${project.version}"/>
            <pathelement path="${basedir}"/>
            <path refId="uportal.classpath"/>
            <fileset refId="uportal-jar.fileset"/>
          </classpath>
          <arg value="-n"/>
          <arg value="${channel}"/>
        </java> 
    </target>

    <!-- End Channel Targets -->

    <!-- uPortal Targets -->
    <artifact:dependencies pathId="uportal.classpath">
      <dependency groupId="org.apache.pluto" artifactId="pluto"
        version="${pluto.version}" type="jar"/>
      <dependency groupId="net.sourceforge.jtds" artifactId="jtds"
        version="${jtds.version}" type="jar"/>
      <dependency groupId="mysql" artifactId="mysql-connector-java"
        version="${mysql.version}" type="jar"/>
      <dependency groupId="com.oracle" artifactId="ojdbc14"
        version="${oracle.version}" type="jar"/>
      <dependency groupId="postgresql" artifactId="postgresql"
        version="${postgresql.version}" type="jar"/>
      <dependency groupId="javax.servlet" artifactId="servlet-api"
        version="${servlet-api.version}" type="jar"/>
      <dependency groupId="commons-dbcp" artifactId="commons-dbcp"
          version="${commons-dbcp.version}" type="jar"/>
      <dependency groupId="commons-logging" artifactId="commons-logging"
          version="${commons-logging.version}" type="jar"/>
      <dependency groupId="org.springframework" artifactId="spring"
          version="${springframework.version}" type="jar"/>
      <dependency groupId="backport-util-concurrent" artifactId="backport-util-concurrent"
          version="${backport-util-concurrent.version}" type="jar"/>
      <dependency groupId="com.whirlycott" artifactId="whirlycache"
          version="${whirlycache.version}" type="jar"/>
      <dependency groupId="dom4j" artifactId="dom4j"
          version="${dom4j.version}" type="jar"/>
      <dependency groupId="jaxen" artifactId="jaxen"
          version="${jaxen.version}" type="jar"/>
      <dependency groupId="commons-jexl" artifactId="commons-jexl"
          version="${commons-jexl.version}" type="jar"/>
      <remoteRepository refid="toro.repository" />
      <remoteRepository refid="central.repository" />
    </artifact:dependencies>

    <artifact:dependencies filesetId="uportal-jar.fileset">
      <dependency groupId="uportal" artifactId="uportal"
          version="${uportal.version}" type="jar"/>
      <remoteRepository refid="uportal.repository" />
    </artifact:dependencies>

    <target name="deploy-uportal" if="run.uportal.deploy">
        <echo>Deploying uPortal ${uportal.version}</echo>
        <condition property="postgres.driver">
            <contains string="${jdbc.driver}" substring="postgres"/>
        </condition>
        <condition property="oracle.driver">
            <contains string="${jdbc.driver}" substring="oracle"/>
        </condition>
        <condition property="mysql.driver">
            <contains string="${jdbc.driver}" substring="mysql"/>
        </condition>
        <condition property="jtds.driver">
            <contains string="${jdbc.driver}" substring="jtds"/>
        </condition>
        <condition property="jnetdirect.driver">
            <contains string="${jdbc.driver}" substring="jnetdirect"/>
        </condition>
        <antcall target="execute-deploy-uportal-with-postgres"/>
        <antcall target="execute-deploy-uportal-with-oracle"/>
        <antcall target="execute-deploy-uportal-with-mysql"/>
        <antcall target="execute-deploy-uportal-with-jtds"/>
        <antcall target="execute-deploy-uportal-with-jnetdirect"/>
    </target>

    <target name="execute-deploy-uportal-with-postgres" if="postgres.driver">
        <echo message="setting postgres db properties..."/>
        <antcall target="execute-deploy-uportal">
            <param name="db.driver.groupId" value="postgresql"/>
            <param name="db.driver.artifactId" value="postgresql"/>
            <param name="db.driver.version" value="${postgresql.version}"/>
        </antcall>
    </target>

    <target name="execute-deploy-uportal-with-oracle" if="oracle.driver">
        <echo message="setting oracle db properties..."/>
        <antcall target="execute-deploy-uportal">
            <param name="db.driver.groupId" value="com.oracle"/>
            <param name="db.driver.artifactId" value="ojdbc14"/>
            <param name="db.driver.version" value="${oracle.version}"/>
        </antcall>
    </target>

    <target name="execute-deploy-uportal-with-mysql" if="mysql.driver">
        <echo message="setting mysql db properties..."/>
        <antcall target="execute-deploy-uportal">
            <param name="db.driver.groupId" value="mysql"/>
            <param name="db.driver.artifactId" value="mysql-connector-java"/>
            <param name="db.driver.version" value="${mysql.version}"/>
        </antcall>
    </target>

    <target name="execute-deploy-uportal-with-jtds" if="jtds.driver">
        <echo message="setting jtds db properties..."/>
        <antcall target="execute-deploy-uportal">
            <param name="db.driver.groupId" value="net.sourceforge"/>
            <param name="db.driver.artifactId" value="jtds"/>
            <param name="db.driver.version" value="${jtds.version}"/>
        </antcall>
    </target>

    <target name="execute-deploy-uportal-with-jnetdirect" if="jnetdirect.driver">
        <echo message="setting jnetdirect db properties..."/>
        <antcall target="execute-deploy-uportal">
            <param name="db.driver.groupId" value="jnetdirect"/>
            <param name="db.driver.artifactId" value="jnetdirect"/>
            <param name="db.driver.version" value="${jnetdirect.version}"/>
        </antcall>
    </target>

    <target name="extract-uportal-jar">
        <antcall target="extract-artifact">
          <param name="groupId" value="uportal"/>
          <param name="artifactId" value="uportal"/>
          <param name="version" value="${uportal.version}"/>
          <param name="target.dir" value="${work.dir}/uportal-${uportal.version}"/>
          <param name="archive.type" value="jar"/>
          <param name="remote.repository" value="uportal.repository"/>
        </antcall>
    </target>

    <target name="extract-uportal-war">
        <antcall target="extract-artifact">
          <param name="groupId" value="uportal"/>
          <param name="artifactId" value="uportal"/>
          <param name="version" value="${uportal.version}"/>
          <param name="target.dir" value="${work.dir}/uportal-${uportal.version}"/>
          <param name="archive.type" value="war"/>
          <param name="remote.repository" value="uportal.repository"/>
        </antcall>
    </target>

    <target name="execute-deploy-uportal">

        <antcall target="extract-uportal-war"/>
 
         <!-- Copy the contents of the build directory -->
         <mkdir     dir="${portal.webapp.home}"/>
         <copy    todir="${portal.webapp.home}">
             <fileset dir="${work.dir}/uportal-${uportal.version}" excludes="stylesheets/**"/>
         </copy>
 
 
         <!-- These are Tomcat-specific!  We need to think about a new property
              that lets us specify the appropriate directory for other servers
         -->
         <artifact:dependencies filesetId="lib.container-shared">
             <dependency groupId="org.apache.pluto" artifactId="pluto"
                 version="${pluto.version}" type="jar"/>
             <dependency groupId="taglibs" artifactId="standard"
                 version="${standard.version}" type="jar"/>
             <dependency groupId="javax.servlet" artifactId="jstl"
                 version="${jstl.version}" type="jar"/>
             <dependency groupId="javax/portlet" artifactId="portlet-api"
                 version="${portlet-api.version}" type="jar"/>
             <remoteRepository refid="toro.repository" />
         </artifact:dependencies>
         <copy flatten="true" todir="${tomcat.home}/shared/lib">
             <fileset refId="lib.container-shared"/>
         </copy>
           
         <mkdir dir="${tomcat.home}/shared/classes/org/jasig/portal/container"/>
         <copy todir="${tomcat.home}/shared/classes/org/jasig/portal/container"
             file="${work.dir}/uportal-${uportal.version}/WEB-INF/classes/org/jasig/portal/container/PortletServlet.class"/>

         <artifact:dependencies filesetId="lib.container-common-endorsed">
             <dependency groupId="serializer" artifactId="serializer"
                 version="${serializer.version}" type="jar"/>
             <dependency groupId="xalan" artifactId="xalan"
                 version="${xalan.version}" type="jar"/>
             <remoteRepository refid="toro.repository" />
         </artifact:dependencies>
         <copy flatten="true" todir="${tomcat.home}/common/endorsed">
             <fileset refId="lib.container-common-endorsed"/>
         </copy>
         <delete>
             <fileset dir="${tomcat.home}/common/endorsed">
                 <include name="xml-api*"/>
             </fileset>
         </delete>
           
         <artifact:dependencies filesetId="lib.container-common">
             <dependency groupId="${db.driver.groupId}" artifactId="${db.driver.artifactId}"
                 version="${db.driver.version}" type="jar"/>
             <remoteRepository refid="toro.repository" />
         </artifact:dependencies>
         <copy flatten="true" todir="${tomcat.home}/common/lib">
             <fileset refId="lib.container-common"/>
         </copy>
 
         <!-- This is Tomcat-specific and server name-specific!
              We need to find out the best way to ensure cross-context
              behavior in all servlet containers.
         -->
           
   
            <!--
                   Copy context configuration into the Tomcat server configuration directory so that Tomcat will configure the
                    context properly.
                    
                    In the "dist" target, the .war produced includes this context declaration in its /META-INF/.
               -->
 
         <copy tofile="${tomcat.host.conf}/${portal.webapp.name}.xml"
             file="${basedir}/properties/uPortal-${uportal.version}/context.xml"
             overwrite="true">
         <filterset>
             <filter token="webappDocBase" value="${portal.webapp.name}"/>
             <filter token="webappPath" value="/${portal.webapp.name}"/>
             <filter token="jdbcDriver" value="${jdbc.driver}"/>
             <filter token="jdbcUrl" value="${jdbc.url}"/>
             <filter token="jdbcUser" value="${jdbc.user}"/>
             <filter token="jdbcPassword" value="${jdbc.password}"/>
             <filter token="poolPreparedStatements" value="true"/>
         </filterset>
         <filterset refid="tokens"/>
           </copy>
           <copy todir="${tomcat.host.conf}" file="${work.dir}/uportal-${uportal.version}/WEB-INF/classes/properties/proxyportlet.xml"/>
 
             <!-- Deploy classes to support the modified version of WSRP4J's proxyportlet.
                  Consider making these classes part of the proxyportlet.war distribution.
             -->
         <mkdir     dir="${portal.webapp.home}/../proxyportlet/WEB-INF/classes/org/jasig/portal/wsrp/consumer/portlet"/>
         <copy    todir="${portal.webapp.home}/../proxyportlet/WEB-INF/classes/org/jasig/portal/wsrp/consumer/portlet">
             <fileset dir="${work.dir}/uportal-${uportal.version}/WEB-INF/classes/org/jasig/portal/wsrp/consumer/portlet"/>
         </copy>
 
         <copy tofile="${portal.webapp.home}/WEB-INF/classes/log4j.properties"
             file="${basedir}/properties/uPortal-${uportal.version}/log4j.properties"
             overwrite="true">
             <filterset refid="tokens"/>
         </copy>

         <copy tofile="${portal.webapp.home}/WEB-INF/classes/properties/portal.properties"
             file="${basedir}/properties/uPortal-${uportal.version}/portal.properties"
             overwrite="true">
             <filterset refid="tokens"/>
         </copy>
   </target>

   <target name="uportal-add-additional-constraints">
       <echo>Adding additional uportal constraints</echo>
       <sql
           driver="${jdbc.driver}"
           url="${jdbc.url}"
           userid="${jdbc.user}"
           password="${jdbc.password}"
           onerror="continue"
           src="${basedir}/db/uportal-additional-constraints-${db.platform}.sql">
           <classpath>
               <path refId="db.classpath"/>
           </classpath>
       </sql>
   </target>

   <target name="create-uportal-properties">
       <mkdir dir="${work.dir}/uportal-properties/properties/db"/>
       <mkdir dir="${work.dir}/uportal-properties/properties/chanpub"/>
       <copy overwrite="true" todir="${work.dir}/uportal-properties/org/jasig/portal/container/deploy">
           <fileset dir="${basedir}/properties/uPortal-${uportal.version}">
               <include name="*.crn"/>
           </fileset>
       </copy>
       <copy overwrite="true" todir="${work.dir}/uportal-properties">
           <fileset dir="${basedir}/properties">
               <include name="log4j.properties"/>
           </fileset>
       </copy>
       <copy overwrite="true" todir="${basedir}">
           <fileset dir="${basedir}/properties/uPortal-${uportal.version}">
               <include name="*.dtd"/>
           </fileset>
       </copy>
       <copy overwrite="true" todir="${basedir}/dtd">
           <fileset dir="${basedir}/properties/uPortal-${uportal.version}">
               <include name="*.dtd"/>
           </fileset>
       </copy>
       <copy overwrite="true" filtering="on" tofile="${work.dir}/uportal-properties/properties/rdbm.properties" file="${basedir}/properties/uPortal-${uportal.version}/rdbm.properties">
           <filterset refid="tokens"/>
       </copy>
       <copy overwrite="true" todir="${work.dir}/uportal-properties/properties/chanpub">
           <fileset dir="${basedir}/properties/uPortal-${uportal.version}/chanpub"/>
       </copy>

       <!-- constructing a dbloader.xml based on the jdbc properties -->
       <copy overwrite="true" todir="${work.dir}/uportal-properties/properties/db" file="${basedir}/properties/uPortal-${uportal.version}/dbloader.xml"/>
        <java outputproperty="db.meta.data" fork="true" failonerror="true" dir="${basedir}" classname="net.unicon.toro.installer.dbloader.DbVersion">
            <classpath>
                <pathelement path="${basedir}"/>
                <path refId="uportal.classpath"/>
            </classpath>
            <arg line="${jdbc.driver} ${jdbc.url} ${jdbc.user} ${jdbc.password}"/>
        </java>
        <echo>db.meta.data =\n${db.meta.data}</echo>
        <copy overwrite="true" todir="${work.dir}" file="${basedir}/properties/dbloader-${db.platform}-mapping.xml">
           <filterset>
               <filter token="db.meta.data" value="${db.meta.data}"/>
           </filterset>
       </copy>
       <antcall target="merge-configuration">
           <param name="configfile" value="${work.dir}/dbloader-${db.platform}-mapping.xml"/>
           <param name="targetdir" value="${work.dir}/uportal-properties"/>
       </antcall>
   </target>

   <target name="uportal-pubchan">
     <echo>uPortal Channel Publishing</echo>
     <property name="channel" value="all"/>

     <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.chanpub.ChannelPublisher">
       <classpath>
         <pathelement path="${work.dir}/uportal-properties"/>
         <path refId="uportal.classpath"/>
         <fileset refId="uportal-jar.fileset"/>
       </classpath>
       <arg value="-n"/>
       <arg value="${channel}"/>
     </java> 
   </target>

   <target name="uportal-i18n-db">
     <echo>uPortal i18n Initialization</echo>
     <property name="usetable" value="-t"/>
     <property name="tablefile" value="/properties/db/tables-i18n.xml"/>
     <property name="usedata" value="-d"/>
     <property name="datafile" value="/properties/db/data-i18n.xml"/>
     <property name="createscript" value=" "/>
     <property name="droptables" value="${uportal.db.droptables.arg}"/>
     <property name="createtables" value=" "/>
     <property name="populatetables" value=" "/>
     <echo>Running DbLoader with droptables option: #${uportal.db.droptables.arg}#</echo>
     <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
       <classpath>
         <pathelement path="${work.dir}/uportal-properties"/>
         <fileset refId="uportal-jar.fileset"/>
         <path refId="uportal.classpath"/>
       </classpath>

       <arg value="${usetable}"/>
       <arg value="${tablefile}"/>
       <arg value="${usedata}"/>
       <arg value="${datafile}"/>
       <arg value="${createscript}"/>
       <arg value="${droptables}"/>
       <arg value="${createtables}"/>
       <arg value="${populatetables}"/>
     </java>
   </target>

   <target name="uportal-pubfragments">
     <echo>uPortal publish fragments</echo>
     <property name="tempDataXML" value="/properties/al/fragment.temp.data.xml"/>
     <property name="fragmentFile" value=" "/>
     <echo message="Resetting layout fragments configuration."/>    <!-- create data.xml file -->
     <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.layout.alm.tool.FragmentLoader">
         <arg value="${fragmentFile}"/>
         <arg value="${work.dir}/uportal-${uportal.version}/WEB-INF/classes${tempDataXML}"/>
         <classpath>
             <pathelement path="${work.dir}/uportal-properties"/>
             <fileset refId="uportal-jar.fileset"/>
             <path refId="uportal.classpath"/>
         </classpath>
     </java>
     <available file="${work.dir}/uportal-${uportal.version}/WEB-INF/classes${tempDataXML}"
         property="temp.fragment.data.file.present"/>
     <antcall target="uportal-pubfragments-load"/>
   </target>

   <target name="uportal-pubfragments-load" if="temp.fragment.data.file.present">
    <echo>Executing uPortal publish fragments</echo>
    <java fork="true" failonerror="true" dir="${build.home}/WEB-INF/classes"
          classname="org.jasig.portal.tools.dbloader.DbLoader">
        <arg value="-d"/>
        <arg value="${tempDataXML}"/>
        <arg value="-nC"/>
        <arg value="-nD"/>
        <arg value="-P"/>
        <classpath>
             <pathelement path="${work.dir}/uportal-properties"/>
             <fileset refId="uportal-jar.fileset"/>
             <path refId="uportal.classpath"/>
        </classpath>
    </java>
    <delete file="${build.home}/WEB-INF/classes/${tempDataXML}"/>
  </target>

   <artifact:dependencies pathId="cernunnos.classpath">
      <dependency groupId="cernunnos" artifactId="cernunnos"
          version="${cernunnos.version}" type="jar"/>
      <remoteRepository refid="toro.repository" />
   </artifact:dependencies>

   <target name="uportal-deploy-testsuite-portlet">
       <antcall target="uportal-deploy-portlet">
           <param name="groupId" value="uportal"/>
           <param name="artifactId" value="testsuite"/>
           <param name="version" value="${uportal.version}"/>
       </antcall>
   </target>

   <target name="uportal-deploy-proxyportlet-portlet">
       <antcall target="uportal-deploy-portlet">
           <param name="groupId" value="uportal"/>
           <param name="artifactId" value="proxyportlet"/>
           <param name="version" value="${uportal.version}"/>
       </antcall>
   </target>

   <target name="uportal-deploy-bookmarks-portlet">
       <antcall target="uportal-deploy-portlet">
           <param name="groupId" value="uportal"/>
           <param name="artifactId" value="BookmarksPortlet"/>
           <param name="version" value="${uportal.version}"/>
       </antcall>
   </target>

   <target name="uportal-deploy-rss-portlet">
       <antcall target="uportal-deploy-portlet">
           <param name="groupId" value="uportal"/>
           <param name="artifactId" value="RssPortlet"/>
           <param name="version" value="${uportal.version}"/>
       </antcall>
   </target>

   <target name="uportal-deploy-google-portlet">
       <antcall target="uportal-deploy-portlet">
           <param name="groupId" value="uportal"/>
           <param name="artifactId" value="googleportlet"/>
           <param name="version" value="${uportal.version}"/>
       </antcall>
   </target>

   <target name="uportal-deploy-portlet">
       <echo>uPortal deploying ${groupId}:${artifactId}:${version} portlet</echo>
     <!--mkdir dir="${work.dir}/uportal-${uportal.version}/lib/portlets"/>
     <copy todir="${work.dir}/lib/portlets">
         <fileset dir="./lib/portlets"/>
     </copy-->
     <!--java fork="true" failonerror="true" dir="${work.dir}/uportal-${uportal.version}" classname="org.danann.cernunnos.runtime.Main"-->


     <artifact:dependencies filesetId="uportal-deploy-portlet.filesetId">
         <dependency groupId="${groupId}" artifactId="${artifactId}"
             version="${version}" type="war"/>
         <remoteRepository refid="uportal.repository" />
     </artifact:dependencies>
     <copy flatten="true" tofile="${basedir}/lib/portlets/${artifactId}.war">
         <fileset refId="uportal-deploy-portlet.filesetId"/>
     </copy>
     <java fork="true" failonerror="true" dir="${basedir}" classname="org.danann.cernunnos.runtime.Main">
       <classpath>
         <pathelement path="${work.dir}/uportal-properties"/>
         <fileset refId="uportal-jar.fileset"/>
         <path refId="uportal.classpath"/>
         <path refId="cernunnos.classpath"/>
       </classpath>
       <arg value="classpath://org/jasig/portal/container/deploy/deploy-portlet-app.crn"/>
       <arg value="lib/portlets/${artifactId}.war"/>
       <arg value="${tomcat.home}/webapps"/>
     </java>
   </target>

   <target name="uportal-load-db">
    <echo>uPortal initialize db</echo>
    <property name="droptables" value="${uportal.db.droptables.arg}"/>
    <echo>Running DbLoader with droptables option: #${uportal.db.droptables.arg}#</echo>
    <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
      <classpath>
        <pathelement path="${work.dir}/uportal-properties"/>
        <fileset refId="uportal-jar.fileset"/>
        <path refId="uportal.classpath"/>
      </classpath>

      <arg value="${droptables}"/>
    </java>
   </target>

   <target name="uportal-dbloader-tables">
       <artifact:dependencies fileSetId="data.loader.file">
           <dependency groupId="${groupId}" artifactId="${artifactId}"
                       version="${version}" type="jar"/>
           <remoteRepository refid="toro.repository" />
       </artifact:dependencies>
       <unjar dest="${work.dir}/uportal-properties/properties/db">
           <fileset refId="data.loader.file"/>
           <patternset>
               <include name="**/dbloader-*.xml"/>
           </patternset>
       </unjar>
       <mkdir dir="${work.dir}/uportal-properties/org/jasig/portal/tools/dbloader"/>
       <echo>Copying ${basedir}/properties/toro_${db.platform}_schema.xsl to ${work.dir}/uportal-properties/org/jasig/portal/tools/dbloader/tables.xsl</echo>
       <copy tofile="${work.dir}/uportal-properties/org/jasig/portal/tools/dbloader/tables.xsl" overwrite="true"
           file="${basedir}/properties/toro_${db.platform}_schema.xsl"/>
       <property name="tables.xml" value="/properties/db/tables.xml"/>
       <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
           <classpath>
               <pathelement path="${work.dir}/uportal-properties"/>
               <fileset refId="uportal-jar.fileset"/>
               <path refId="uportal.classpath"/>
           </classpath>

           <arg line="${uportal.db.droptables.arg} -C -nP -t /properties/db/dbloader-tables.xml"/>
       </java>
       <delete>
           <fileset dir="${work.dir}/uportal-properties/properties/db">
               <patternset>
                   <include name="**/dbloader-*.xml"/>
               </patternset>
           </fileset>
       </delete>
   </target>

   <target name="uportal-dbloader-data">
       <artifact:dependencies fileSetId="data.loader.file">
           <dependency groupId="${groupId}" artifactId="${artifactId}"
                       version="${version}" type="jar"/>
           <remoteRepository refid="toro.repository" />
       </artifact:dependencies>
       <unjar dest="${work.dir}/uportal-properties/properties/db">
           <fileset refId="data.loader.file"/>
           <patternset>
               <include name="**/dbloader-*.xml"/>
           </patternset>
       </unjar>
       <property name="tables.xml" value="/properties/db/tables.xml"/>
       <property name="data.xml" value="/properties/db/dbloader-data.xml"/>
       <java fork="true" failonerror="true" dir="${basedir}" classname="org.jasig.portal.tools.dbloader.DbLoader">
           <classpath>
               <pathelement path="${work.dir}/uportal-properties"/>
               <fileset refId="uportal-jar.fileset"/>
               <path refId="uportal.classpath"/>
           </classpath>

           <arg line="-nD -nC -P -t ${tables.xml} -d ${data.xml}"/>
       </java>
   </target>
    <!-- End uPortal Targets -->
</project>
